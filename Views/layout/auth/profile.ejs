<form id="updatedForm">

  <div class="form-group">
    <label for="name" class="form-label">Nome Completo</label>
    <input type="text" id="name" name="name" class="form-control" value="<%= session.user.name %>" />
  </div>

  <div class="form-group">
    <div>
      <label for="email" class="form-label" style="margin-bottom: 0">
        E-mail</label>

      <% if (session.user.email && session.user.email.verified) { %>
        <span class="verification-badge verified">
          <i class="material-icons">check_circle</i> Verificado
        </span>
        <% } else if (session.user.email) { %>
          <span class="verification-badge not-verified">
            <i class="material-icons">warning</i>
            <a href="/resend-otp/<%= session.user.email.endereco %>" style="color: #e65100">
              (Verificar agora)</a>
          </span>
          <% } %>
    </div>
    <input type="email" id="email" name="email" class="form-control" value="<%= session.user.email.endereco %>" />
  </div>

  <div class="form-group">
    <div>
      <label for="phone" class="form-label">Telefone</label>
      <% if (session.user.phone && session.user.phone.verified) { %>
        <span class="verification-badge verified">
          <i class="material-icons">check_circle</i> Verificado
        </span>
        <% } else if (session.user.phone && session.user.phone.number) { %>
          <span class="verification-badge not-verified">
            <i class="material-icons">warning</i>
            <a style="color: #e65100" class="verify-link">(Verificar agora)</a>
          </span>
          <% } %>
    </div>
    <input type="tel" class="form-control" id="phone" name="phone" value="<%= session.user.phone.number %>" />

    <input type="hidden" id="full_phone" name="full_phone" />
    <input type="hidden" id="id" name="id" value="<%= session.user._id %>">
  </div>

  <div style="text-align: right; margin-top: 2rem">
    <button type="submit" id="saveButton" class="btn btn-destaque">Salvar Alterações</button>
  </div>
</form>

<div id="message" class="mt-3"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/23.0.10/js/intlTelInput.min.js"></script>
<script>
  const phoneInputField = document.querySelector("#phone");
  const phoneInput = window.intlTelInput(phoneInputField, {
    utilsScript:
      "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/23.0.10/js/utils.js",
    initialCountry: "br",
    preferredCountries: ["br", "us", "pt"],
    separateDialCode: true,
    formatOnDisplay: true,
  });

  document
    .getElementById("updatedForm")
    .addEventListener("submit", async function (event) {
      event.preventDefault();

      const saveButton = document.getElementById("saveButton");
      const originalButtonText = saveButton.textContent;

      saveButton.textContent = "Sending...";
      saveButton.disabled = true;

      function showNotification(mensagem, isSuccess) {
        notification.textContent = mensagem;
        notification.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      const fullPhone = phoneInput.getNumber();

      document.getElementById("full_phone").value = fullPhone;
      data.phone = fullPhone;

      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      try {
        const response = await fetch("/auth/updatedUser", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          saveButton.textContent = "atualizado";

        } else {
          showNotification(result.mensagem, result.success);
        }
      } catch (error) {
        console.error("Error:", error);
        showNotification(result.mensagem, result.success);
      }

      setTimeout(() => {
        saveButton.textContent = originalButtonText;
        saveButton.disabled = false;
      }, 3000);

    });
</script>