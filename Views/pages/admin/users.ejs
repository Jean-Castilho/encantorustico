<div class="container">
    <link rel="stylesheet" href="/css/main.css">

    <header class="page-header">
        <h1>Gerenciamento de Usuários</h1>
    </header>

    <div class="inventory-container">

        <% if (users && users.length > 0) { %>
            <div class="inventory-table-container">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Tipo</th>
                            <th>Data de Cadastro</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(user => { %>
                            <% 
                                const nome = user.name || 'Sem nome';
                                const email = user.email.endereco || 'Sem email';
                                const userType = user.role || 'user';
                                
                                const isActive = user.isActive === true;

                                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('pt-BR') : '—';
                            %>
                            <tr>
                                <td><strong><%= nome %></strong></td>
                                <td><%= email %></td>
                                <td><%= userType %></td>
                                <td><%= createdAt %></td>
                                <td>
                                    <% if (isActive) { %>
                                        <span class="status-badge status-active">Ativo</span>
                                    <% } else { %>
                                        <span class="status-badge status-inactive">Inativo</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/admin/user/edit/<%= user._id %>" class="btn btn-sm btn-secundario">Editar</a>
                                        <form class="delete-user-form">
                                            <input type="hidden" name="id" value="<%= user._id %>">
                                            <button type="submit" class="btn btn-sm btn-remover">Excluir</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <div class="inventory-actions">
                <a href="/admin/users/add" class="btn btn-destaque">Adicionar Novo Usuário</a>
            </div>

        <% } else { %>

            <div class="inventory-actions">
                <a href="/admin/users/add" class="btn btn-destaque">Adicionar Novo Usuário</a>
            </div>

            <div class="alert alert-info">
                Nenhum usuário encontrado. <a href="/admin/users/add">Adicione um novo usuário</a>.
            </div>
        <% } %>

    </div>
</div>

<script>
    document.querySelectorAll('.delete-user-form').forEach(form => {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const button = this.querySelector('button[type="submit"]');
            const originalButtonText = button.textContent;
            const userId = this.querySelector('input[name="id"]').value;

            if (!confirm(`Tem certeza que deseja excluir este usuário?`)) {
                return;
            }

            const notification = document.getElementById('notification-home') || (()=>{
                const newDiv = document.createElement('div');
                newDiv.id = 'notification-home';
                document.body.prepend(newDiv);
                return newDiv;
            })();

            function showNotification(message, isSuccess) {
                notification.textContent = message;
                notification.className = isSuccess ? 'notification success' : 'notification error';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            button.textContent = "Removendo...";
            button.disabled = true;

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: "DELETE",
                    headers: {
                        'X-CSRF-Token': csrfToken
                    },
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(result.message, true);
                    this.closest('tr').remove();
                } else {
                    showNotification(result.message || 'Ocorreu um erro.', false);
                }
            } catch (error) {
                console.error("Error:", error);
                showNotification("Ocorreu um erro ao excluir o usuário.", false);
            } finally {
                button.textContent = originalButtonText;
                button.disabled = false;
            }
        });
    });
</script>