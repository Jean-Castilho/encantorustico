<style>
    .order-card {
        background-color: #fff;
        border-radius: var(--borda-radius);
        box-shadow: var(--sombra-padrao);
        margin-bottom: 2rem;
        overflow: hidden;
        /* Para garantir que o header se ajuste ao card */
    }

    .order-header {
        background-color: #f8f9fa;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--cor-borda);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        font-size: 0.9rem;
    }

    .order-header-item strong {
        display: block;
        color: #6c757d;
        font-weight: normal;
        margin-bottom: 0.25rem;
    }

    .order-body {
        padding: 1.5rem;
    }

    .order-item {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--cor-borda);
    }

    .order-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .order-item-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: var(--borda-radius);
    }

    .order-item-details {
        flex-grow: 1;
    }

    .order-item-details h5 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
    }

    .order-item-details p {
        margin: 0;
        color: #6c757d;
    }

    .order-item-price {
        font-weight: bold;
        font-size: 1.1rem;
        text-align: right;
    }

    .status {
        font-weight: bold;
        padding: 0.3rem 0.6rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .status-pending_payment {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-processing {
        background-color: #cce5ff;
        color: #004085;
    }

    .status-approved,
    .status-paid {
        background-color: #d4edda;
        color: #155724;
    }

    .status-cancelled {
        background-color: #f8d7da;
        color: #721c24;
    }

    .order-summary {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    /* Controls */
    .orders-controls input,
    .orders-controls select {
        font-size: 0.95rem;
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .order-header {
            grid-template-columns: 1fr 1fr;
        }

        .order-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .order-item .order-item-details {
            max-width: 100%;
        }

        .order-summary {
            flex-direction: column;
        }

        .order-actions {
            justify-content: flex-start;
        }
    }

    .summary-box {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: var(--borda-radius);
        flex: 1 1 220px;
    }

    .timeline {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 0.75rem;
    }

    .timeline-step {
        padding: 0.4rem 0.6rem;
        border-radius: 0.5rem;
        background: #e9ecef;
        color: #495057;
        font-size: 0.8rem;
    }

    .timeline-step.active {
        background: #007bff;
        color: white;
        font-weight: 600;
    }
</style>

<div class="container">
    <header class="page-header" style="text-align: center; margin-bottom: 3rem;">
        <h1 style="margin-bottom: 0px; margin-top: 1.5rem;">
            <%= titulo %>
        </h1>
    </header>

    <% if (orders && orders.length> 0) { %>
        <% orders.forEach(order=> { %>
            <div class="order-card">

                <div class="order-header">
                    <div class="order-header-item">
                        <strong>PEDIDO REALIZADO EM</strong>
                        <span>
                            <%= formatters.formatDate(order.createdAt) %> - <%= formatters.formatTime(order.createdAt) %>
                        </span>
                    </div>
                    <div class="order-header-item">
                        <strong>STATUS</strong>
                        <span class="status status-<%= (order.status || '').toLowerCase().replace(/\s+/g, '_') %>">
                            <%= formatters.statusLabel(order.status) %>
                        </span>
                    </div>


                    <div class="order-header-item">
                        <strong>PEDIDO Nº</strong>
                        <span>
                            <%= order._id.toString().slice(-10) %>
                        </span>
                    </div>
                    <div class="order-header-item">
                        <strong>TOTAL</strong>
                        <span>
                            <%= formatters.formatCurrency(order.valor) %>
                        </span>
                    </div>
                </div>

                <div class="order-body">

                    <% order.items.forEach(item=> { %>
                        <div class="order-item">
                            <% if (item && item.imagens && item.imagens.length> 0) { %>
                                <img src="/uploads/<%= item.imagens[0] %>" alt="<%= item.name %>"
                                    class="order-item-img">
                                <div class="order-item-details">
                                    <h5>
                                        <%= item.name %>
                                    </h5>
                                    <p>Quantidade: <%= item.quantity || 1 %>
                                    </p>
                                    <p>SKU: <%= item.sku || '-' %>
                                    </p>
                                </div>

                                <div class="order-item-price">
                                    <div>Unit: <%= formatters.formatCurrency(item.valor || 0) %>
                                    </div>
                                    <div>Subtotal: <%= formatters.formatCurrency((item.valor || 0) * (item.quantity ||
                                            1)) %>
                                    </div>
                                </div>
                                <% } else { %>
                                    <div class="order-item-details">
                                        <h5>Produto não disponível</h5>
                                        <p>Este produto não pode mais ser exibido.</p>
                                    </div>
                                    <% } %>
                        </div>
                        <% }); %>


                            <div class="order-summary">
                                <div class="summary-box">
                                    <strong>Endereço de entrega</strong>
                                    <div style="margin-top:0.5rem; color: #495057;">
                                        <% if (order.endereco) { %>
                                            <div>
                                                • CEP: <%= order.endereco.cep || order.endereco.zip || '' %> </br>
                                                    • Estado: <%= order.endereco.estado || order.endereco.state || '' %>

                                            </div>
                                            <div>
                                                • Bairo: <%= order.endereco.bairro || order.endereco.district || '' %>
                                                    </br>
                                                    • Cidade: <%= order.endereco.cidade || order.endereco.city || '' %>
                                            </div>

                                            <div>
                                                • rua: <%= order.endereco.logradouro || order.endereco.rua || '' %>
                                                    </br>
                                                    • casa: <%= order.endereco.numero || order.endereco.number || '' %>
                                            </div>
                                            <% } else { %>
                                                <div>Endereço não informado</div>
                                                <% } %>
                                    </div>
                                </div>

                                <div class="summary-box">
                                    <strong>Pagamento</strong>
                                    <div style="margin-top:0.5rem; color: #495057;">
                                        <% if (order.paymentMethod) { %>
                                            <div>
                                                Método de pagamento: <%= order.paymentMethod.payment_method %>
                                            </div>
                                                    <% } else { %>
                                                        <div>Método não informado</div>
                                                        <% } %>
                                    </div>
                                </div>

                                <div class="summary-box">
                                    <strong>Resumo</strong>
                                    <div style="margin-top:0.5rem; color: #495057;">
                                        <div>Itens: <%= order.items.length %>
                                        </div>
                                        <div>Subtotal: <%= formatters.formatCurrency(((order.valor || 0) -
                                                (order.shipping || 0) - (order.tax || 0))) %>
                                        </div>
                                        <div>Frete: <%= formatters.formatCurrency(order.shipping || 0) %>
                                        </div>
                                        <div>Taxas: <%= formatters.formatCurrency(order.tax || 0) %>
                                        </div>
                                        <div style="font-weight:700; margin-top:0.5rem;">Total: <%= formatters.formatCurrency(order.valor) || 0 %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">

                                <div>
                                    <div class="timeline">
                                        <% const statusTranslations = { 'pending' : 'pendente' , 'approved'
                                            : 'pagamento aprovado' , 'processing' : 'processando' , 'shipped'
                                            : 'enviado' , 'delivered' : 'entregue' , 'cancelled' : 'cancelado' }; %>

                                            <% const steps = ['pending', 'approved' , 'processing' , 'shipped'
                                                , 'delivered' , 'cancelled' ]; %>

                                                <% steps.forEach( s => { %>
                                                    <% const cls = (s === order.status) ? 'timeline-step active'
                                                        : 'timeline-step'; %>
                                                        <div class="<%= cls %>">
                                                            <%= (statusTranslations[s] || s).replace('_', ' ').toUpperCase() %>
                                                        </div>
                                                    <% }); %>
                                    </div>
                                    
                                </div>

                                <div style="display:flex; gap:0.5rem;">
                                    <% if (order.status==='pending' ) { %>
                                        <a href="/orders/pay/<%= order._id %>" class="btn btn-primary">Pagar</a>
                                        <a href="/orders/cancel/<%= order._id %>"
                                            class="btn btn-outline-danger">Cancelar</a>
                                        <% } else { %>
                                            <a href="/orders/invoice/<%= order._id %>"
                                                class="btn btn-outline-secondary">Baixar fatura</a>
                                            <% } %>
                                                <a href="/support?order=<%= order._id %>"
                                                    class="btn btn-outline-info">Suporte</a>
                                </div>

                </div>
            </div>

</div>
<% }); %>
    <% } else { %>
        <div class="card" style="text-align: center; padding: 4rem;">
            <h2>Nenhum pedido encontrado.</h2>
            <p style="margin-top: 1rem; margin-bottom: 2rem;">Parece que você ainda não fez nenhuma compra.
                Que tal explorar nossos produtos?</p>
            <a href="/products" class="btn btn-destaque">Ver Produtos</a>
        </div>
        <% } %>
            </div>