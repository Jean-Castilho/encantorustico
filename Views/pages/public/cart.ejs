<div class="container" id="cart-container">
    <header class="page-header" style="text-align: center; margin-bottom: 3rem;">
        <h1>Meu Carrinho de Compras</h1>
    </header>

    <% if (cart && cart.items && cart.items.length> 0) { %>
        <% let totalPrice=0; let totalItems=0; cart.items.forEach(item=> {
            const price = parseFloat(item.preco) || 0;
            const quantity = parseInt(item.quantity, 10) || 0;
            totalPrice += price * quantity;
            totalItems += quantity;
            }); %>

            <form action="/checkout" method="GET">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2.5rem; align-items: start;"
                    id="cart-content">

                    <!-- Coluna dos Itens -->
                    <section class="cart-items-column">
                        <% cart.items.forEach(item=> { %>

                            <% let id=item._id; %>

                                <div class="cart-item" data-item-id="<%= item._id %>"
                                    data-item-price="<%= item.preco %>" data-item-quantity="<%= item.quantity %>">

                                    
                                    <input type="checkbox" name="selectedItems" value="<%= item._id %>"
                                        class="item-checkbox" checked style="transform: scale(1.5);">


                                    <img src="/uploads/<%= item.imagens[0] %>" alt="<%= item.nome %>">
                                    <div class="item-details">
                                        <h3>
                                            <%= item.nome %>
                                        </h3>
                                        <p><strong>R$ <%= (parseFloat(item.preco)) %></strong></p>
                                    </div>
                                    <button class="btn btn-remover" data-product-id="<%= id %>">Remover</button>
                                </div>
                                <% }); %>
                    </section>

                    <!-- Coluna do Resumo -->
                    <aside class="summary-column">
                        <div class="card">
                            <h4>Resumo do Pedido</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span id="total-items-count">Subtotal (<%= totalItems %> itens)</span>
                                <strong id="total-price-display">R$ <%= totalPrice.toFixed(2).replace('.', ',' ) %>
                                </strong>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; font-size: 1.2rem; margin-bottom: 2rem;">
                                <span>Valor Total</span>
                                <strong id="total-price-display-main">R$ <%= totalPrice.toFixed(2).replace('.', ',' ) %>
                                </strong>
                            </div>
                            <button type="submit" class="btn btn-destaque" style="width: 100%;">Finalizar
                                Compra</button>
                            <a href="/products" class="btn btn-secundario"
                                style="width: 100%; margin-top: 1rem;">Continuar Comprando</a>
                        </div>
                    </aside>
                </div>
            </form>
            <% } else { %>
                <div class="card" style="text-align: center; padding: 4rem;">
                    <h2>Seu carrinho está vazio.</h2>
                    <p style="margin-top: 1rem; margin-bottom: 2rem;">Adicione produtos para vê-los aqui.</p>
                    <a href="/products" class="btn btn-destaque">Ver Produtos</a>
                </div>
                <% } %>
</div>

<div id="notification-cart"
    style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1050; padding: 15px; border-radius: 5px; color: white;">
</div>

<style>
    @media (max-width: 992px) {
        .container div[style*="grid"] {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    const notification = document.getElementById('notification-cart');

    function showNotification(message, isSuccess) {
        notification.textContent = message;
        notification.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    function updateSummary() {
        let totalPrice = 0;
        let totalItems = 0;

        document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const itemElement = checkbox.closest('.cart-item');
            if (itemElement) {
                const price = parseFloat(itemElement.dataset.itemPrice) || 0;
                const quantity = parseInt(itemElement.dataset.itemQuantity, 10) || 0;
                totalPrice += price * quantity;
                totalItems += quantity;
            }
        });

        const formattedPrice = totalPrice.toFixed(2).replace('.', ',');
        const totalItemsCountEl = document.getElementById('total-items-count');
        const totalPriceDisplayEl = document.getElementById('total-price-display');
        const totalPriceDisplayMainEl = document.getElementById('total-price-display-main');

        if (totalItemsCountEl) totalItemsCountEl.textContent = `Subtotal (${totalItems} itens)`;
        if (totalPriceDisplayEl) totalPriceDisplayEl.textContent = `R$ ${formattedPrice}`;
        if (totalPriceDisplayMainEl) totalPriceDisplayMainEl.textContent = `R$ ${formattedPrice}`;
    }

    async function removeCart(id, buttonElement) {
        if (!id) {
            showNotification('Produto inválido.', false);
            return;
        }

        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'Removendo...';
        }

        try {
            const response = await fetch(`/cart/remove/${encodeURIComponent(id)}`, {
                method: 'POST',
            });

            const result = await response.json().catch(() => ({
                success: response.ok,
                message: 'Resposta inesperada do servidor.'
            }));

            if (!response.ok) {
                showNotification(result.message || 'Erro ao remover o item.', false);
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.textContent = 'Remover';
                }
                return;
            }

            const itemElement = document.querySelector(`.cart-item[data-item-id="${id}"]`);
            if (itemElement) {
                itemElement.remove();
            }

            updateSummary(); // Atualiza o resumo localmente
            showNotification(result.message || 'Item removido com sucesso!', true);

            // Se o carrinho ficar vazio, recarrega a página para mostrar o estado "vazio"
            if (document.querySelectorAll('.cart-item').length === 0) {
                window.location.reload();
            }

        } catch (err) {
            showNotification('Erro de rede ao remover o item.', false);
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.textContent = 'Remover';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const removeButtons = document.querySelectorAll('.btn-remover');
        removeButtons.forEach(button => {
            button.addEventListener('click', event => {
                event.preventDefault();
                const id = button.getAttribute('data-product-id');
                removeCart(id, button);
            });
        });

        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSummary);
        });

        // Garante que o resumo seja calculado na carga inicial da página
        updateSummary();
    });
</script>