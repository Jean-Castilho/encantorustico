<%
  const cart = session?.user?.cart || [];
  const id = product._id || product.id || '';
  const isInCart = cart.includes(id.toString());
%>

<div class="container product-detail-page">
    <!-- Product Image Gallery -->
    <div class="product-gallery">
        <% if (product.imagens && product.imagens.length > 0) { %>
            <div class="main-product-image">
                <img src="/uploads/<%= product.imagens[0] %>" alt="<%= product.nome %>" id="current-main-image">
            </div>
            <div class="product-thumbnails">
                <% product.imagens.forEach((image, index) => { %>
                    <img src="/uploads/<%= image %>" alt="<%= product.nome %> thumbnail" class="thumbnail-item <%= index === 0 ? 'active' : '' %>" onclick="changeMainImage(this)">
                <% }); %>
            </div>
        <% } else { %>
            <div class="main-product-image">
                <img src="/images/no-image.png" alt="Imagem não disponível">
            </div>
        <% } %>
    </div>

    <!-- Product Details -->
    <div class="product-details">
        <h1 class="product-title"><%= product.nome %></h1>

        <div class="product-buy-box">
            <div class="product-price-section">
                <p class="product-price">
                    <% if (product.preco != null) { %>
                        <%= Number(product.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) %>
                    <% } else { %>
                        Preço sob consulta
                    <% } %>
                </p>
            </div>

            <form id="add-to-cart-form" class="add-to-cart-form <%= isInCart ? 'in-cart' : '' %>">
                <input type="hidden" name="id" value="<%= id %>">
                <div class="quantity-selector-wrapper">
                    <label for="quantity" class="quantity-label">Quantidade:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" class="form-control quantity-input">
                </div>
                <button type="submit" class="btn btn-destaque add-to-cart-btn">
                    <%= isInCart ? 'Ver Carrinho' : 'Adicionar ao Carrinho' %>
                </button>
            </form>
            <div id="notification"></div>
        </div>

        <!-- Product Info Tabs -->
        <div class="product-info-tabs">
            <div class="tab-headers">
                <button class="tab-link active" onclick="openTab(event, 'description')">Descrição</button>
                <button class="tab-link" onclick="openTab(event, 'details')">Detalhes</button>
            </div>

            <div id="description" class="tab-content active">
                <p class="product-description"><%- product.descricao %></p>
            </div>

            <div id="details" class="tab-content">
                <div class="product-meta-data">
                    <% if (product.categoria) { %><p class="meta-item"><strong>Categoria:</strong> <%= product.categoria %></p><% } %>
                    <% if (product.material) { %><p class="meta-item"><strong>Material:</strong> <%= product.material %></p><% } %>
                    <% if (product.dimensoes) { %><p class="meta-item"><strong>Dimensões:</strong> <%= product.dimensoes %></p><% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function changeMainImage(thumbnail) {
        const mainImage = document.getElementById('current-main-image');
        mainImage.src = thumbnail.src;

        document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
        thumbnail.classList.add('active');
    }

    function openTab(event, tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));

        document.getElementById(tabName).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize first tab and thumbnail
        const firstThumbnail = document.querySelector('.thumbnail-item');
        if (firstThumbnail) {
            firstThumbnail.classList.add('active');
        }
        document.querySelector('.tab-link').click();


        const addToCartForm = document.getElementById('add-to-cart-form');
        const notification = document.getElementById('notification');

        addToCartForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (addToCartForm.classList.contains('in-cart')) {
                window.location.href = '/cart';
                return;
            }

            const id = addToCartForm.querySelector('input[name="id"]').value;
            const quantity = addToCartForm.querySelector('input[name="quantity"]').value;

            try {
                const response = await fetch(`/cart/add/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: quantity })
                });

                const result = await response.json();

                notification.textContent = result.message;
                notification.className = result.success ? 'success' : 'error';
                notification.style.display = 'block';

                if (result.success) {
                    addToCartForm.classList.add('in-cart');
                    addToCartForm.querySelector('button').textContent = 'Ver Carrinho';
                    // Update cart icon/count if necessary
                }

            } catch (error) {
                notification.textContent = 'Ocorreu um erro ao adicionar o produto ao carrinho.';
                notification.className = 'error';
                notification.style.display = 'block';
            }

            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        });
    });
</script>